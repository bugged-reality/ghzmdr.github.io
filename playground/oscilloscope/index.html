<!DOCTYPE html>
<html>
<head>
    <title>Analyser test</title>
</head>
<body>

    <canvas width="500" height="300" style="border: 1px solid red"></canvas>

    <div class="buttons">
        <button data-source="noise">Noise</button>
        <button data-source="audio">Audio</button>
        <button data-source="microphone">Microphone</button>
    </div>


    <audio controls src="./test.mp3" id="sink"></audio>


    <script type="text/javascript">

    var canvas = document.querySelector('canvas')
    var canvasContext = canvas.getContext('2d')

    var buttonsSrc = document.querySelectorAll('button')

    for (var i = 0; i < buttonsSrc.length; ++i) {
        buttonsSrc[i].addEventListener('click', handleButtonClick)
    }

    var audioElement = document.querySelector('audio')

    var AudioContext = window.AudioContext || window.webkitAudioContext
    var audioContext = new AudioContext();

    var noiseSource, audioSource, microphoneSource, lastSource
    audioSource = audioContext.createMediaElementSource(audioElement)
    noiseSource = audioContext.createOscillator();
    noiseSource.type = 'square';
    noiseSource.loop = true;
    noiseSource.frequency.value = 300; // value in hertz
    noiseSource.start()

    var audioAnalyser = audioContext.createAnalyser();
    audioAnalyser.fftSize = 64;
    var bufferLength = audioAnalyser.frequencyBinCount;
    var dataArray = new Uint8Array(bufferLength);

    var stripeWidth = 500 / bufferLength
    canvasContext.strokeWidth = stripeWidth - (stripeWidth / 10)
    canvasContext.strokeStyle = 'green';

    function fromNoise() {
        noiseSource.connect(audioAnalyser)
        noiseSource.connect(audioContext.destination)

        lastSource = noiseSource
    }

    function fromAudio() {
        audioSource.connect(audioAnalyser)
        audioSource.connect(audioContext.destination)
        audioElement.play()
        lastSource = audioSource
    }

    function fromMicrophone() {
        if (!microphoneSource) {
            window.navigator.mediaDevices.getUserMedia({audio: true})
                .then(function(stream) {
                    microphoneSource = audioContext.createMediaStreamSource(stream)
                    microphoneSource.connect(audioAnalyser)
                    microphoneSource.connect(audioContext.destination);
                    lastSource = microphoneSource
                })
        } else {
            microphoneSource.connect(audioAnalyser)
            microphoneSource.connect(audioContext.destination);
            lastSource = microphoneSource
        }
    }

    function swapSource(sourceName) {
        if (lastSource) {
            lastSource.disconnect(audioAnalyser);
            lastSource.disconnect(audioContext.destination);
        }

        switch (sourceName) {
            case 'noise': return fromNoise();
            case 'audio': return fromAudio();
            case 'microphone': return fromMicrophone();
        }
    }

    function handleButtonClick(e) {
        swapSource(e.currentTarget.dataset.source)
    }

    function loop() {
        draw()
        requestAnimationFrame(loop)
    }

    function draw() {
        canvasContext.clearRect(0, 0, 500, 300)
        audioAnalyser.getByteFrequencyData(dataArray);

        for (var i = 0; i < bufferLength; ++i) {
            canvasContext.beginPath()
            canvasContext.moveTo(i * stripeWidth, 0)
            canvasContext.lineTo(i * stripeWidth, (500 * (dataArray[i] / 255)))
            canvasContext.stroke()
        }
    }

    loop()
    </script>
</body>
</html>
