<!DOCTYPE html>
<html>
<head>
    <title>Get User Media</title>
    <link href="https://fonts.googleapis.com/css?family=Lato|Roboto" rel="stylesheet">

    <style type="text/css">
        html {
            font-family: Lato;
            text-align: center;
        }

        .content {
            width: 90%;
            max-width: 800px;
            margin: 0 auto;
            text-align: center;
        }

        #sink {
            width: 100%;
            background-color: #424242;

            margin-bottom: 1rem;
        }

        .advice {
            display: block;
            color: #FFA726;
            font-size: 0.8em;
            margin-bottom: 1rem;

            text-decoration: underline;
            font-weight: bold;
        }

        button, input[type=radio] + label {
            padding: 0.4em 1rem;
            outline: none;
            color: #424242;
            border: none;
            border-radius: 4px;
            cursor: hand;
            cursor: pointer;
            background-color: rgb(192, 192, 192);
        }

        input[type=radio]:checked + label {
            background-color: #673AB7;
            color: white;
        }

        button[disabled] {
            color: rgb(142, 142, 142);
        }

        label {
            font-family: Roboto;
            font-size: 0.8rem;
        }

        input[type=radio] {
            width: 1px;
            height: 1px;
            opacity: 0;
        }

        #error {
            display: block;
            color: #DD2C00;
        }

    </style>
</head>
<body>

    <div class="content">
        <audio id="sink" controls autoplay playsinline></audio>
        <div class="advice">Warning: wear your headphones and/or lower the volume</div>
        <button id="button-play">Start capturing</button> <input type="checkbox" name="with-video" id="with-video"><label for="with-video">Capture video</label>
        <p id="error"></p>

        <div class="filters">

            <input type="radio" name="filter" id="filter-chorus" value="chorus"><label for="filter-chorus">Chorus</label>
            <input type="radio" name="filter" id="filter-overdrive" value="overdrive"><label for="filter-overdrive">Overdrive</label>
            <input type="radio" name="filter" id="filter-convolver" value="convolver"><label for="filter-convolver">Convolver</label>
            <input type="radio" name="filter" id="filter-pingpong" value="pingpong"><label for="filter-pingpong">PingPong</label>
            <input type="radio" name="filter" id="filter-wahwah" value="wahwah"><label for="filter-wahwah">Wahwah</label>
            <input type="radio" name="filter" id="filter-delay" value="delay"><label for="filter-delay">Delay</label>

        </div>
    </div>

    <script type="text/javascript" src="./tuna-min.js"></script>
    <script type="text/javascript" src="./overdrive.js"></script>

    <script type="text/javascript">

        var Application = function () {

            this.video = document.getElementById('sink')
            this.buttonPlay =  document.getElementById('button-play')
            this.error = document.getElementById('error')
            this.checkboxVideo = document.getElementById('with-video')

            this.filterButtons = document.querySelectorAll('input[name=filter]');

            this.constraints = {
                audio : true,
                video : false
            }

            this.audioSource = null
            this.audioContext = new (window.webkitAudioContext || window.AudioContext)()
            this.audioGain = this.audioContext.createGain();
            this.tuna = new Tuna(this.audioContext);

            this.createFilters();

            this.startCapture = this.startCapture.bind(this);
            this.handleUserMediaError = this.handleUserMediaError.bind(this);
            this.handleUserMediaStream = this.handleUserMediaStream.bind(this);

            this.buttonPlay.addEventListener('click', this.startCapture);

            this.filterButtons.forEach(function(button) {
                button.addEventListener('click', this.setFilter.bind(this, button.value))
            }.bind(this))
        }

        Application.prototype = {

            setFilter: function(key) {
                alert('Setting filter ' + key)
                for (var k in this.filters) {
                    this.filters[k].bypass = true
                }

                if (key === 'delay') {
                    this.filters[k].delayTime.value = 1
                } else {
                    // this.audioGain.disconnect(this.filters.custom)
                    this.filters.custom.disconnect(this.audioGain)
                    this.filters.custom.disconnect(this.audioContext.destination)

                    this.filters[key].bypass = false
                }

            },

            createFilters: function () {
                this.filters = {
                    chorus: new this.tuna.Chorus({
                        rate: 1.5,
                        feedback: 0.2,
                        delay: 0.0045,
                        bypass: 0
                    }),

                    overdrive: new this.tuna.Overdrive({
                        outputGain: 0.1,         //0 to 1+
                        drive: 0.7,              //0 to 1
                        curveAmount: 1,          //0 to 1
                        algorithmIndex: 0,       //0 to 5, selects one of our drive algorithms
                        bypass: 0
                    }),

                    convolver: new this.tuna.Convolver({
                        highCut: 22050,                         //20 to 22050
                        lowCut: 20,                             //20 to 22050
                        dryLevel: 1,                            //0 to 1+
                        wetLevel: 1,                            //0 to 1+
                        level: 1,                               //0 to 1+, adjusts total output of both wet and dry
                        impulse: "impulses/impulse_rev.wav",    //the path to your impulse response
                        bypass: 0
                    }),

                    wahwah: new this.tuna.WahWah({
                        automode: true,                //true/false
                        baseFrequency: 0.5,            //0 to 1
                        excursionOctaves: 2,           //1 to 6
                        sweep: 0.2,                    //0 to 1
                        resonance: 10,                 //1 to 100
                        sensitivity: 0.5,              //-1 to 1
                        bypass: 0
                    }),

                    pingpong: new this.tuna.PingPongDelay({
                        wetLevel: 0.5, //0 to 1
                        feedback: 0.3, //0 to 1
                        delayTimeLeft: 150, //1 to 10000 (milliseconds)
                        delayTimeRight: 200 //1 to 10000 (milliseconds)
                    }),

                    delay: this.audioContext.createDelay()
                }

            },

            handleUserMediaError: function(e) {
                this.error.innerText = e.toString() + '\n --- ' + JSON.stringify(e)
            },

            handleUserMediaStream: function(stream) {
                this.error.innerText = ""
                this.video.srcObject = stream

                this.audioSource = this.audioContext.createMediaStreamSource(stream)

                this.attachFilters()

                this.buttonPlay.disabled = true
                this.checkboxVideo.disabled = true

                this.video.play()
            },

            attachFilters: function() {

                this.audioSource.connect(this.audioGain);
                for (var k in this.filters) {
                    this.audioGain.connect(this.filters[k])

                    this.filters[k].connect(this.audioContext.destination)
                    this.filters[k].bypass = true

                    if (k === 'delay') {
                        this.filters[k].delayTime.value = 0;
                    }
                }
            },

            startCapture: function() {
                var getUserMedia
                if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                    getUserMedia = navigator.mediaDevices.getUserMedia.bind(navigator.mediaDevices)
                } else {
                    getUserMedia = window.getUserMedia
                }

                getUserMedia({
                    audio: true,
                    video: this.checkboxVideo.checked
                }).then(this.handleUserMediaStream)
                  .catch(this.handleUserMediaError)
            }
        }

        window.onload = function() {
            window.application = new Application();
            if (window.eruda) eruda.init();
        }


    </script>
    <script>
        if (/eruda=true/.test(window.location) && localStorage.getItem('active-eruda') != 'true') {
            document.write('<scr' + 'ipt src="//cdn.jsdelivr.net/eruda/1.2.2/eruda.min.js"></scr' + 'ipt>');
            document.write('<scr' + 'ipt>eruda.init();</scr' + 'ipt>');
        }
    </script>

</body>

</html>
